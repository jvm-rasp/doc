# attach 的常见坑


## 程序包com.sun.tools.attach不存在

## 不同jdk版本的attach返回结果不同

在jdk8，attach返回结果为，

在jdk11 返回结果为 return 0:

使用低版本的 api 对高版本的Java进场发起注入时，

使用 jdk8 的api


## attach 失败


## .java_pid文件丢失

### 现象
当执行attach命令如jstack时，出现报错 Unable to open socket file: target process not responding or HotSpot VM not loaded
```text
MacBook-Pro admin$ jstack 33000
33000: Unable to open socket file: target process not responding or HotSpot VM not loaded
The -F option can be used when the target process is not responding
```
同时确认/tmp目录下没有attach通讯的socket文件进程.java_pid文件
```text
MacBook-Pro admin$ ls .java_pid3000
ls: .java_pid3000: No such file or directory
```
然而，重启Java进程之后又可以使用jstack等attach工具了

### 原因

很不幸，这个是一个JDK的bug，原因是VM在第一次被attach时会创建.java_pid${pid}用于socket通信，
文件目录在/tmp目录下（不同操作系统tmp目录位置不同），该目录不可以被参数修改。 
这个文件首次被创建后，vm 会标记attach listener 为 initialized，
一旦文件本删除，这个Java进程再也不能被attach了。tmp目录不足并且该文件是隐藏文件，很容易被清理。

### 方案
+ 对于JDK8 来说，只能重启进程。
+ 官方修复
```text

```





## 文件权限问题

https://www.dandelioncloud.cn/article/details/1497179081337835522



## 容器中pid为1的Java进程无法atatch

```text
com.sun.tools.attach.AttachNotSupportedException: Unable to get pid of LinuxThreads manager thread
    at sun.tools.attach.LinuxVirtualMachine.<init>(LinuxVirtualMachine.java:86)
    at sun.tools.attach.LinuxAttachProvider.attachVirtualMachine(LinuxAttachProvider.java:78)
    at com.sun.tools.attach.VirtualMachine.attach(VirtualMachine.java:250)
```

## attach 触发 fullgc

一般来说，主动触发fullgc的命令是`jmap -histo:live ${pid}`,其他方案很难触发，如果JVM参数有

