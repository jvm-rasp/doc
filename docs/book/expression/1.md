## 10.1 SpEL使用与源码解析

熟悉表达式的使用对于漏洞的检测是非常关键的，本节将详细介绍表达式的各种用法。

### 10.1.1 基本语法与使用

+ 执行字符串表达式
```java
ExpressionParser parser = new SpelExpressionParser();
Expression exp = parser.parseExpression("'Hello World'"); 
String message = (String) exp.getValue();
```

+ 调用方法
```java
ExpressionParser parser = new SpelExpressionParser();
Expression exp = parser.parseExpression("'Hello World'.concat('!')"); 
String message = (String) exp.getValue();
```
+ 访问属性
```java
ExpressionParser parser = new SpelExpressionParser();

// invokes 'getBytes()'
Expression exp = parser.parseExpression("'Hello World'.bytes"); 
byte[] bytes = (byte[]) exp.getValue();
```

SpEL还通过使用标准点表示法（如prop1.prop2.prop3）和属性值的设置来支持嵌套属性。
也可以访问公共字段。以下示例显示了如何使用点表示法来获取文字的长度：
```java
ExpressionParser parser = new SpelExpressionParser();

// invokes 'getBytes().length'
Expression exp = parser.parseExpression("'Hello World'.bytes.length"); 
int length = (Integer) exp.getValue();
```
+ 调用构造函数

可以使用new运算符来调用构造函数。除了基元类型（int、float等）和String之外， 其他类型都应该使用完全限定类名。
java.lang包下的类可以使用短名称，如下例子：
```java
// 调用String类的构造器创建一个新的字符串并将其转换为大写
ExpressionParser parser = new SpelExpressionParser();
Expression exp = parser.parseExpression("new String('hello world').toUpperCase()"); 
String message = exp.getValue(String.class);
```

使用完全限定类名创建对象，如下所示：
```java
Inventor einstein = p.parseExpression(
        "new org.spring.samples.spel.inventor.Inventor('Albert Einstein', 'German')")
        .getValue(Inventor.class);

//create new inventor instance within add method of List
p.parseExpression(
        "Members.add(new org.spring.samples.spel.inventor.Inventor(
            'Albert Einstein', 'German'))").getValue(societyContext);
```

+ T()表达式

还可以使用特殊的T运算符来指定java.lang.Class的实例。静态方法也可以通过使用此运算符来调用。
与创建对象一样，java.lang包下的类型的使用T()引用不需要完全限定名称，但所有其他类型引用都必须是完全限定名称。
以下示例说明如何使用T运算符：
```java
Class dateClass = parser.parseExpression("T(java.util.Date)").getValue(Class.class);

Class stringClass = parser.parseExpression("T(String)").getValue(Class.class);

boolean trueValue = parser.parseExpression(
        "T(java.math.RoundingMode).CEILING < T(java.math.RoundingMode).FLOOR")
        .getValue(Boolean.class);
```

这里仅介绍几个在漏洞利用中使用批量较高的用法，完整的使用教程可以参考spring官方文档，链接如下：
> SpEL官方文档：https://docs.spring.io/spring-framework/docs/5.1.6.RELEASE/spring-framework-reference/core.html#expressions

### 10.1.2 源码解析

```java
import org.springframework.expression.Expression;
import org.springframework.expression.ExpressionParser;
import org.springframework.expression.spel.standard.SpelExpressionParser;

public class Main {
    public static void main(String[] args) {
        ExpressionParser parser = new SpelExpressionParser();
        Expression exp = parser.parseExpression("T(java.lang.Math).random() * 100.0");
        Float value = exp.getValue(Float.class);
        System.out.println("value: " + value);
    }
}
```
![截屏2024-04-09 下午11.21.47.png](..%2F..%2F..%2F..%2FDesktop%2F%E6%88%AA%E5%B1%8F2024-04-09%20%E4%B8%8B%E5%8D%8811.21.47.png)

